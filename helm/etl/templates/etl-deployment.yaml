apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.etl.name | quote }}
spec:
  selector:
    matchLabels:
      app: {{ .Values.etl.name | quote }}
  replicas: 1
  revisionHistoryLimit: 5
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: {{ .Values.etl.name | quote }}
    spec:
      terminationGracePeriodSeconds: 10
      containers:
        - name: db
          image: {{ .Values.etl.image | quote }}
          resources: {{ toYaml .Values.etl.resources | nindent 12 }}
          env:
            - name: EXTERNAL_ADDRESS
              value: {{ .Values.etl.EXTERNAL_ADDRESS | quote }}
            {{- if .Values.etl.S3SecretName }}
            - name: BUCKET_NAME
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.S3SecretName | quote }}, "key":"BUCKET_NAME"}}
            - name: AWS_ACCESS_KEY_ID
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.S3SecretName | quote }}, "key":"AWS_ACCESS_KEY_ID"}}
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.S3SecretName | quote }}, "key":"AWS_SECRET_ACCESS_KEY"}}
            - name: S3_ENDPOINT_URL
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.S3SecretName | quote }}, "key":"S3_ENDPOINT_URL"}}
            - name: AWS_REGION
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.S3SecretName | quote }}, "key":"AWS_REGION"}}
            {{- else }}
            - name: BUCKET_NAME
              value: "dgp-app"
            - name: AWS_ACCESS_KEY_ID
              value: "access_key"
            - name: AWS_SECRET_ACCESS_KEY
              value: "secret_key"
            - name: S3_ENDPOINT_URL
              value: "http://{{ .Values.minio.name }}:9000"
            - name: AWS_REGION
              value: "us-east-1"
            {{- end }}
            - name: GOOGLE_KEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"GOOGLE_KEY"}}
            - name: GOOGLE_SECRET
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"GOOGLE_SECRET"}}
            - name: PUBLIC_KEY_B64
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"PUBLIC_KEY_B64"}}
            - name: PRIVATE_KEY_B64
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"PRIVATE_KEY_B64"}}
            - name: SENDGRID_API_KEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"SENDGRID_API_KEY"}}
            - name: DATABASE_URL
              value: "postgresql://postgres:postgres@{{ .Values.db.name }}/auth"
            - name: DATASETS_DATABASE_URL
              value: "postgresql://postgres:postgres@{{ .Values.db.name }}/datasets"
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              value: "postgresql://postgres:postgres@{{ .Values.db.name }}/airflow"
            - name: ETLS_DATABASE_URL
              value: "postgresql://postgres:postgres@{{ .Values.db.name }}/etls"
            - name: ETL_GOOGLE_MAPS_API_KEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GOOGLE_MAPS_API_KEY"}}
            - name: ETL_DATAFLOWS_AIRTABLE_APIKEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_DATAFLOWS_AIRTABLE_APIKEY"}}
            - name: ETL_CLICK_API
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_CLICK_API"}}
            - name: ETL_GUIDESTAR_USERNAME
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GUIDESTAR_USERNAME"}}
            - name: ETL_GUIDESTAR_PASSWORD
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GUIDESTAR_PASSWORD"}}
            - name: ETL_GUIDESTAR_API
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GUIDESTAR_API"}}
            - name: ETL_GOVMAP_API_KEY
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GOVMAP_API_KEY"}}
            - name: ETL_GOVMAP_AUTH
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GOVMAP_AUTH"}}
            - name: ETL_GOVMAP_REQUEST_ORIGIN
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GOVMAP_REQUEST_ORIGIN"}}
            - name: ETL_GOVMAP_GEOCODE_API
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_GOVMAP_GEOCODE_API"}}
            - name: ETL_AIRTABLE_BASE
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_BASE"}}
            - name: ETL_AIRTABLE_VIEW
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_VIEW"}}
            - name: ETL_AIRTABLE_LOCATION_TABLE
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_LOCATION_TABLE"}}
            - name: ETL_AIRTABLE_ORGANIZATION_TABLE
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_ORGANIZATION_TABLE"}}
            - name: ETL_AIRTABLE_BRANCH_TABLE
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_BRANCH_TABLE"}}
            - name: ETL_AIRTABLE_SITUATION_TABLE
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_AIRTABLE_SITUATION_TABLE"}}
            - name: ETL_MAPBOX_ACCESS_TOKEN
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_MAPBOX_ACCESS_TOKEN"}}
            - name: ETL_MAPBOX_LIST_TILESETS
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_MAPBOX_LIST_TILESETS"}}
            - name: ETL_MAPBOX_UPLOAD_CREDENTIALS
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_MAPBOX_UPLOAD_CREDENTIALS"}}
            - name: ETL_MAPBOX_CREATE_UPLOAD
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_MAPBOX_CREATE_UPLOAD"}}
            - name: ETL_MAPBOX_UPLOAD_STATUS
              valueFrom: {"secretKeyRef":{"name":{{ .Values.etl.secretName | quote }}, "key":"ETL_MAPBOX_UPLOAD_STATUS"}}
